<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Suivi des actions - Loire-Authion Autrement</title>
    
    <link rel="icon" href="logo.jpg" type="image/jpeg">
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css">
    
    <style>
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: sans-serif; }
        
        /* HEADER */
        #header { height: 70px; background: #2c3e50; color: white; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; z-index: 2000; position: relative; transition: all 0.3s; }
        .stats-container { width: 300px; text-align: right; margin-left: 15px; }
        .progress { height: 10px; background-color: #4a6278; }
        
        /* CARTE */
        #map { height: calc(100vh - 70px); width: 100%; background: #e5e5e5; }
        
        /* BARRE DE RECHERCHE */
        #search-container { position: absolute; top: 85px; left: 50%; transform: translateX(-50%); width: 300px; z-index: 1000; transition: top 0.3s ease; }
        #search-input { width: 100%; padding: 10px; border-radius: 20px; border: 2px solid rgba(0,0,0,0.2); box-shadow: 0 4px 6px rgba(0,0,0,0.1); outline: none; font-size: 16px; background: white; }
        #search-results { background: white; margin-top: 5px; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.2); display: none; max-height: 300px; overflow-y: auto; }
        .search-result-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; font-size: 13px; }
        .search-result-item:hover { background-color: #f8f9fa; }

        /* LEGENDE */
        .legend-container { position: absolute; bottom: 30px; right: 10px; z-index: 1000; background: white; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.2); overflow: hidden; width: 200px; transition: all 0.3s ease; }
        .legend-header { padding: 10px 15px; background: #f8f9fa; border-bottom: 1px solid #eee; cursor: pointer; font-weight: bold; display: flex; justify-content: space-between; align-items: center; user-select: none; }
        .legend-content { padding: 15px; }
        .legend-container.collapsed .legend-content { display: none; }
        .legend-container.collapsed { width: auto; }
        .legend-item { margin-bottom: 8px; display: flex; align-items: center; }
        .legend-color { width: 20px; height: 20px; border-radius: 4px; margin-right: 10px; display: inline-block; }
        
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(44, 62, 80, 0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; color: white; transition: opacity 0.5s ease; }
        .loading-overlay.hidden { opacity: 0; pointer-events: none; }
        
        /* CONTROLES CARTE */
        .leaflet-left .leaflet-control { margin-bottom: 10px; }
        .leaflet-control-geoloc { background-color: white; width: 34px; height: 34px; border-radius: 4px; border: 2px solid rgba(0,0,0,0.2); cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .geoloc-icon { width: 20px; height: 20px; fill: #333; }
        .source-info { position: absolute; bottom: 5px; left: 5px; font-size: 10px; color: #666; z-index: 1000; background: rgba(255,255,255,0.7); padding: 2px 5px; border-radius: 3px; pointer-events: none; }
        
        .custom-filter select { pointer-events: auto; background: white; border: 2px solid rgba(0,0,0,0.4); border-radius: 4px; padding: 5px; font-weight: bold; font-size: 13px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.4); }

        .leaflet-control-layers { border: 2px solid rgba(0,0,0,0.4) !important; border-radius: 4px !important; box-shadow: 0 2px 5px rgba(0,0,0,0.4) !important; margin-left: 10px !important; }
        .leaflet-control-layers-expanded { padding: 8px !important; font-size: 13px !important; font-weight: bold !important; color: #333 !important; background: white !important; }

        /* UTILITAIRES VISUELS */
        path.leaflet-interactive:focus { outline: none; }
        .leaflet-interactive { -webkit-tap-highlight-color: transparent; }

        .panneau-tooltip { font-size: 14px !important; font-family: sans-serif !important; border: 1px solid #666 !important; min-width: 250px !important; max-width: 400px !important; white-space: normal !important; padding: 10px !important; line-height: 1.4 !important; background-color: white !important; color: black !important; box-shadow: 0 4px 10px rgba(0,0,0,0.3) !important; opacity: 1 !important; border-radius: 6px !important; z-index: 9000 !important; }
        .street-tooltip { background: rgba(255, 255, 255, 0.95); border: 1px solid #333; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.4); font-weight: bold; font-size: 12px; padding: 2px 6px; color: #333; }
        
        .note-tooltip { background: #6f42c1; color: white; border: none; border-radius: 4px; padding: 5px 10px; font-weight: bold; }
        .note-popup .leaflet-popup-content-wrapper { background: #f8f9fa; border-radius: 8px; }
        .btn-delete-note { background-color: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; font-size: 12px; cursor: pointer; width: 100%; margin-top: 5px; }

        .user-location-marker { background-color: #4285F4; border: 2px solid white; border-radius: 50%; box-shadow: 0 0 5px rgba(0,0,0,0.3); animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(66, 133, 244, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(66, 133, 244, 0); } 100% { box-shadow: 0 0 0 0 rgba(66, 133, 244, 0); } }

        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #2c3e50; z-index: 100000; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }

        /* ========================================= */
        /* --- OPTIMISATIONS MOBILE & TABLETTE --- */
        /* ========================================= */
        @media (max-width: 768px) {
            /* 1. Header plus compact */
            #header { height: 60px; padding: 0 10px; }
            #header img { height: 35px; }
            #header h1 { font-size: 0.8rem; line-height: 1.1; white-space: normal; }
            .stats-container { width: 110px; margin-left: 8px; }
            #stats-text { font-size: 0.7rem; }
            #map { height: calc(100vh - 60px); }

            /* 2. Barre de recherche : En haut */
            #search-container { width: 90%; top: 70px; }
            
            /* 3. Masquer le zoom bouton */
            .leaflet-control-zoom { display: none; }

            /* 4. L√©gende discr√®te */
            .legend-container { width: 160px; bottom: 20px; right: 5px; }
            .legend-content { padding: 10px; font-size: 12px; }
            
            /* 5. FIX CRUCIAL : On descend les contr√¥les (Boutons) BEAUCOUP plus bas */
            /* Pour laisser la place √† la barre de recherche sans chevauchement */
            .leaflet-top { top: 130px; transition: top 0.3s; } 
            .leaflet-control-layers { margin-top: 0 !important; }
        }
    </style>
</head>
<body>

    <div id="login-screen">
        <img src="logo.jpg" alt="Logo" style="height: 80px; width: auto; margin-bottom: 20px; border-radius: 50%; object-fit: contain; background: white; padding: 5px;">
        <h2 class="h4 mb-4">Acc√®s s√©curis√©</h2>
        <div class="d-flex flex-column align-items-center gap-2">
            <input type="password" id="password-input" class="form-control text-center" placeholder="Mot de passe" style="width: 250px;">
            <button onclick="checkPassword()" class="btn btn-success w-100 fw-bold">Entrer</button>
            <p id="login-error" class="text-danger mt-2 fw-bold" style="display: none;">Mot de passe incorrect</p>
        </div>
        <small class="text-white-50 mt-5">Loire-Authion Autrement</small>
    </div>

    <div id="header">
        <div class="d-flex align-items-center">
            <img src="logo.jpg" alt="Logo" style="height: 50px; width: auto; margin-right: 15px; object-fit: contain;">
            <div>
                <h1 class="h6 m-0 fw-bold text-nowrap">Suivi des actions<br>Loire-Authion Autrement</h1>
                <small class="text-white-50 d-none d-sm-block" style="font-size: 0.7rem;">¬© Cl√©ment LE GRAND</small>
            </div>
        </div>
        <div class="stats-container">
            <div class="d-flex justify-content-between mb-1" style="font-size: 0.9rem;">
                <span id="stats-text">Connexion...</span>
                <span id="stats-percent" class="fw-bold text-success">--%</span>
            </div>
            <div class="progress">
                <div id="progress-bar" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
            </div>
        </div>
    </div>
    
    <div id="search-container">
        <input type="text" id="search-input" placeholder="üîç Rechercher une rue..." onkeyup="searchStreets()">
        <div id="search-results"></div>
    </div>

    <div id="map"></div>
    <div id="source-display" class="source-info">Source: Chargement...</div>

    <div class="legend-container" id="legend">
        <div class="legend-header" onclick="toggleLegend()">
            L√©gende <span id="legend-arrow">‚ñº</span>
        </div>
        <div class="legend-content">
            <div class="legend-item"><span class="legend-color" style="background: rgba(0,0,255,0.0); border: 2px solid blue;"></span><span>Fronti√®res</span></div>
            <div class="legend-item"><span class="legend-color" style="background: rgba(220, 53, 69, 0.4);"></span><span>Rue √† faire</span></div>
            <div class="legend-item"><span class="legend-color" style="background: #fd7e14;"></span><span>En cours / √Ä repasser</span></div>
            <div class="legend-item"><span class="legend-color" style="background: #28a745;"></span><span>Rue faite</span></div>
            <hr style="margin: 8px 0;">
            <div class="legend-item"><span class="legend-color" style="background: #dc3545; border: 2px solid white; border-radius: 50%;"></span><span>Panneau √† faire</span></div>
            <div class="legend-item"><span class="legend-color" style="background: #28a745; border: 2px solid white; border-radius: 50%;"></span><span>Panneau fait</span></div>
            <div class="legend-item"><span class="legend-color" style="background: #6f42c1; border: 2px solid white; border-radius: 50%;"></span><span>Note (Appui long)</span></div>
        </div>
    </div>
    
    <div id="loading" class="loading-overlay">
        <div class="spinner-border text-light mb-3" role="status" style="width: 3rem; height: 3rem;"></div>
        <div id="loading-msg" class="fs-5">D√©marrage...</div>
        <small id="server-status" class="text-warning mt-3" style="font-size: 0.8rem;"></small>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script src="https://unpkg.com/osmtogeojson@2.2.12/osmtogeojson.js"></script>
    <script src="https://unpkg.com/@turf/turf/turf.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, set, remove, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // CONFIGURATION
        const MOT_DE_PASSE = "loire2026";
        const LISTE_PANNEAUX = [
            { lat: 47.455777409985004, lng: -0.39837537609926976, colA: "Maison des loisirs", colB: "Rue du parc 49800 Loire-Authion", colC: "Sous le pr√©au de la maison des loisirs" },
            { lat: 47.47820216373718, lng: -0.39149954760158634, colA: "Lieu-dit Ridereau", colB: "1748-1766 Rte de Ridereau 49800 Loire-Authion", colC: "Croisement des routes" },
            { lat: 47.505927278068725, lng: -0.4094311644596668, colA: "Lieu-dit Les Vigneaux", colB: "1291 La Faussarderie 49800 Loire-Authion", colC: "Bord de route en face d'une habitation" },
            { lat: 47.50293533205733, lng: -0.3171753895165719, colA: "Stade / Salle des Sports", colB: "Rue de la B√©loini√®re 49140 Loire-Authion", colC: "Parking du stade" },
            { lat: 47.44557950645388, lng: -0.4118279205928237, colA: "Mairie / Centre", colB: "Place de l'H√¥tel de Ville 49800 Loire-Authion", colC: "Sur la droite de la mairie, derri√®re les buissons" },
            { lat: 47.471563744222365, lng: -0.3503568272932749, colA: "Logis des Moines", colB: "Place du Logis des Moines 49630 Loire-Authion", colC: "Sur le parking" },
            { lat: 47.42059427312846, lng: -0.3912382730538779, colA: "√âglise Saint-Aubin", colB: "Place de l'√âglise 49800 Loire-Authion", colC: "Sur la gauche de l'√©glise" },
            { lat: 47.41939389040162, lng: -0.4352542358182484, colA: "√âcole / Mairie", colB: "37 Rue Lig√©rienne 49800 Loire-Authion", colC: "Sur le parking" },
            { lat: 47.41063925701801, lng: -0.320567301278285, colA: "Salle des F√™tes", colB: "Place du 19 Mars 1962 49250 Loire-Authion", colC: "En face de la mairie ou pr√®s du parking attenant" }
        ];

        const firebaseConfig = {
            apiKey: "AIzaSyDV11Ne09SvKOkyti5EfjRM8UYmwlpqhGA",
            authDomain: "suivi-actions-loire-authion.firebaseapp.com",
            databaseURL: "https://suivi-actions-loire-authion-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "suivi-actions-loire-authion",
            storageBucket: "suivi-actions-loire-authion.firebasestorage.app",
            messagingSenderId: "693650330058",
            appId: "1:693650330058:web:42f3c6cbbfa0b2366fff33"
        };
        const OVERPASS_SERVERS = [ "https://overpass-api.de/api/interpreter", "https://lz4.overpass-api.de/api/interpreter", "https://overpass.kumi.systems/api/interpreter", "https://maps.mail.ru/osm/tools/overpass/api/interpreter", "https://overpass.privatenet.de/api/interpreter" ];
        const COLOR_TODO = "#dc3545"; const COLOR_DOING = "#fd7e14"; const COLOR_DONE = "#28a745"; const OPACITY_TODO = 0.4; const OPACITY_DONE = 0.8;

        window.toggleLegend = function() {
            const legend = document.getElementById('legend');
            const arrow = document.getElementById('legend-arrow');
            legend.classList.toggle('collapsed');
            arrow.innerText = legend.classList.contains('collapsed') ? '‚ñ≤' : '‚ñº';
        };

        window.searchStreets = function() {
            const input = document.getElementById('search-input').value.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            const resultsDiv = document.getElementById('search-results');
            resultsDiv.innerHTML = '';
            if (input.length < 3) { resultsDiv.style.display = 'none'; return; }
            const matches = allLayersList.filter(l => !l.isPanneau && l.streetNameNormal && l.streetNameNormal.includes(input)).slice(0, 5);
            if (matches.length > 0) {
                resultsDiv.style.display = 'block';
                matches.forEach(layer => {
                    const div = document.createElement('div');
                    div.className = 'search-result-item'; div.innerText = layer.streetNameDisplay;
                    div.onclick = () => { map.fitBounds(layer.getBounds(), { maxZoom: 17 }); layer.openTooltip(); resultsDiv.style.display = 'none'; };
                    resultsDiv.appendChild(div);
                });
            } else { resultsDiv.style.display = 'none'; }
        };
        document.addEventListener('click', function(e) { if (!document.getElementById('search-container').contains(e.target)) document.getElementById('search-results').style.display = 'none'; });

        window.checkPassword = function() {
            if (document.getElementById('password-input').value === MOT_DE_PASSE) {
                document.getElementById('login-screen').style.display = 'none'; localStorage.setItem('map_auth', 'true'); 
            } else { document.getElementById('login-error').style.display = 'block'; }
        };
        if (localStorage.getItem('map_auth') === 'true') document.getElementById('login-screen').style.display = 'none';

        // FIREBASE & GLOBALS
        let db; try { const app = initializeApp(firebaseConfig); db = getDatabase(app); } catch (e) { console.error("Erreur Firebase:", e); }
        
        const planLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { maxZoom: 19, attribution: 'Plan' });
        const satLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19, attribution: 'Satellite' });
        const map = L.map('map', { layers: [planLayer], doubleClickZoom: false }).setView([47.44, -0.40], 13);

        let streetsGroup = L.layerGroup().addTo(map);
        let panneauxGroup = L.layerGroup().addTo(map);
        let notesGroup = L.layerGroup().addTo(map);
        let userMarker = null;

        let allLayersList = []; let communesPolygons = null; let totalStreetsCount = 0; let latestFirebaseData = {}; let latestNotesData = {}; let currentFilter = 'all'; 

        const GeolocControl = L.Control.extend({
            onAdd: function(map) {
                const div = L.DomUtil.create('div', 'leaflet-control-geoloc leaflet-bar leaflet-control');
                div.innerHTML = `<svg class="geoloc-icon" viewBox="0 0 24 24"><path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"/></svg>`;
                div.onclick = function(e) { e.stopPropagation(); map.locate({ setView: true, maxZoom: 16, timeout: 30000, enableHighAccuracy: false }); }; return div;
            }
        });
        map.addControl(new GeolocControl({ position: 'topleft' }));

        map.on('locationfound', function(e) {
            if (userMarker) { map.removeLayer(userMarker); }
            const gpsIcon = L.divIcon({ className: 'user-location-marker', iconSize: [20, 20], iconAnchor: [10, 10] });
            userMarker = L.marker(e.latlng, {icon: gpsIcon}).addTo(map);
            // Suppression du popup "Vous √™tes ici"
        });

        const FilterControl = L.Control.extend({
            onAdd: function(map) {
                const div = L.DomUtil.create('div', 'leaflet-bar leaflet-control custom-filter');
                div.innerHTML = `<select onmousedown="L.DomEvent.stopPropagation(event)" style="height:30px;"><option value="all">Statut : Tout</option><option value="done">Statut : Fait</option><option value="doing">Statut : En cours</option><option value="todo">Statut : √Ä faire</option></select>`;
                div.querySelector('select').addEventListener('change', function(e) { currentFilter = e.target.value; updateMapDisplay(); }); return div;
            }
        });
        map.addControl(new FilterControl({ position: 'topleft' }));

        const baseMaps = { "Plan": planLayer, "Satellite": satLayer };
        const overlays = { "Rues": streetsGroup, "Panneaux": panneauxGroup, "Notes": notesGroup };
        L.control.layers(baseMaps, overlays, { position: 'topleft', collapsed: false }).addTo(map);

        function handleAddNote(e) {
            const noteText = prompt("Ajouter une note √† cet endroit :");
            if (noteText) {
                push(ref(db, 'notes'), { lat: e.latlng.lat, lng: e.latlng.lng, text: noteText, timestamp: Date.now() });
            }
        }
        map.on('contextmenu', handleAddNote);
        map.on('click', function(e) { if (e.originalEvent.ctrlKey) handleAddNote(e); });

        window.deleteNote = function(noteId) {
            if (confirm("Supprimer cette note ?")) { remove(ref(db, 'notes/' + noteId)); }
        };

        function sanitizeId(id) {
            if (!id) return "inconnu_" + Math.random().toString(36).substr(2, 9);
            return String(id).toLowerCase().replace(/[^a-z0-9]/g, "_");
        }

        async function initMap() {
            try {
                document.getElementById('loading-msg').innerText = "Lecture export.geojson...";
                const response = await fetch('export.geojson');
                if (!response.ok) throw new Error("Fichier export.geojson introuvable.");
                const textData = await response.text();
                communesPolygons = (textData.trim().startsWith('<')) ? osmtogeojson(new DOMParser().parseFromString(textData, "text/xml")) : JSON.parse(textData);
                
                const boundaryLayer = L.geoJSON(communesPolygons, { 
                    style: function(feature) { return { color: "blue", weight: 2, fillColor: "blue", fillOpacity: 0, interactive: false }; },
                    filter: function(feature) { return feature.geometry.type !== "Point"; }
                }).addTo(map);
                map.fitBounds(boundaryLayer.getBounds());

                // --- PANNEAUX ---
                LISTE_PANNEAUX.forEach(panneau => {
                    const panneauId = "panneau_" + panneau.lat.toString().replace('.','_') + "_" + panneau.lng.toString().replace('.','_');
                    const marker = L.circleMarker([panneau.lat, panneau.lng], { radius: 12, weight: 2, opacity: 1, fillOpacity: 1, color: "white", fillColor: COLOR_TODO });
                    marker.streetId = panneauId; marker.isPanneau = true; 
                    const infoText = `<div style="text-align:left;"><strong style="font-size:16px; display:block; margin-bottom:5px; color:#2c3e50;">${panneau.colA}</strong><span style="display:block; margin-bottom:8px; font-size:14px;">${panneau.colB}</span><em style="color:#000; display:block; border-top:1px solid #ccc; padding-top:8px; font-style:italic; font-weight:normal;">${panneau.colC}</em></div>`;
                    marker.bindTooltip(infoText, { direction: 'top', offset: [0, -15], opacity: 1, className: 'panneau-tooltip' });
                    marker.on('click', function(e) {
                        const currentStatus = (latestFirebaseData[panneauId] && latestFirebaseData[panneauId].status) || 'todo';
                        const newState = (currentStatus === 'done') ? "todo" : "done";
                        set(ref(db, 'rues/' + panneauId), { status: newState, name: panneau.colA + " (" + panneau.colB + ")", updatedAt: Date.now() });
                    });
                    allLayersList.push(marker);
                });
                updateMapDisplay();

                document.getElementById('loading-msg').innerText = "Chargement des rues...";
                await loadStreetsRobust(boundaryLayer.getBounds());

                listenToDatabaseUpdates();
                document.getElementById('loading').classList.add('hidden');
            } catch (error) { alert("Erreur Init : " + error.message); }
        }

        async function loadStreetsRobust(bounds) {
            const s = bounds.getSouth(); const w = bounds.getWest(); const n = bounds.getNorth(); const e = bounds.getEast();
            const query = `[out:json][timeout:25];(way["highway"~"^(residential|living_street|tertiary|unclassified|service|secondary)$"](${s},${w},${n},${e}););out geom;`;
            let osmData = null; let success = false;
            for (const serverUrl of OVERPASS_SERVERS) {
                try {
                    const response = await fetch(serverUrl, { method: "POST", body: "data=" + encodeURIComponent(query) });
                    if (response.ok) { osmData = await response.json(); success = true; break; }
                } catch (err) {}
            }
            if (!success) throw new Error("Serveurs OSM indisponibles.");
            const rawStreets = osmtogeojson(osmData);
            const filteredFeatures = rawStreets.features.filter(street => {
                if (street.geometry.type !== 'LineString' && street.geometry.type !== 'MultiLineString') return false;
                let isInside = false;
                communesPolygons.features.forEach(commune => { if (commune.geometry && turf.booleanIntersects(street, commune)) isInside = true; });
                return isInside;
            });
            totalStreetsCount = filteredFeatures.length; 
            L.geoJSON({type: "FeatureCollection", features: filteredFeatures}, {
                style: { color: COLOR_TODO, weight: 6, opacity: OPACITY_TODO, lineCap: 'round' },
                onEachFeature: function(feature, layer) {
                    const props = feature.properties; const tags = props.tags || props; let streetName = "";
                    if (tags.name) { streetName = tags.name; if (tags.ref) streetName += ` (${tags.ref})`; } 
                    else if (tags.ref) { streetName = `Route ${tags.ref}`; } 
                    else { const typeTrad = { 'residential': 'Rue r√©sidentielle', 'service': 'Voie de service', 'living_street': 'Zone de rencontre', 'unclassified': 'Route mineure', 'tertiary': 'Route locale', 'secondary': 'Route d√©partementale', 'primary': 'Route principale', 'track': 'Chemin', 'path': 'Sentier' }; streetName = typeTrad[tags.highway] || "Voie sans nom"; }
                    
                    let rawId = feature.id; if (!rawId) rawId = "no_id_" + Math.random().toString(36).substr(2, 9);
                    const uniqueId = sanitizeId(rawId);
                    layer.streetId = uniqueId; layer.streetNameDisplay = streetName;
                    layer.streetNameNormal = streetName.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                    layer.bindTooltip(streetName, { sticky: true, className: 'street-tooltip' });
                    layer.on('click', function(e) {
                        const currentStatus = (latestFirebaseData[uniqueId] && latestFirebaseData[uniqueId].status) || 'todo';
                        let nextStatus = 'todo';
                        if (currentStatus === 'todo') nextStatus = 'doing'; else if (currentStatus === 'doing') nextStatus = 'done'; else if (currentStatus === 'done') nextStatus = 'todo';
                        set(ref(db, 'rues/' + uniqueId), { status: nextStatus, name: streetName, updatedAt: Date.now() });
                    });
                    layer.on('mouseover', function(e) { e.target.setStyle({ weight: 9 }); });
                    layer.on('mouseout', function(e) { e.target.setStyle({ weight: 6 }); });
                    allLayersList.push(layer);
                }
            });
            updateMapDisplay(); 
        }

        function updateMapDisplay() {
            streetsGroup.clearLayers(); panneauxGroup.clearLayers(); let doneCount = 0;
            allLayersList.forEach(layer => {
                const streetData = latestFirebaseData[layer.streetId];
                const status = (streetData && streetData.status) ? streetData.status : 'todo';
                if (status === 'done' && !layer.isPanneau) doneCount++;
                if (layer.isPanneau) { layer.setStyle({ fillColor: status === 'done' ? COLOR_DONE : COLOR_TODO, color: "white" }); } 
                else {
                    let color = COLOR_TODO; let opacity = OPACITY_TODO;
                    if (status === 'done') { color = COLOR_DONE; opacity = OPACITY_DONE; } else if (status === 'doing') { color = COLOR_DOING; opacity = OPACITY_DONE; }
                    layer.setStyle({ color: color, opacity: opacity });
                }
                let matchesStatus = false;
                if (currentFilter === 'all') matchesStatus = true; else if (currentFilter === status) matchesStatus = true;
                if (matchesStatus) { if (layer.isPanneau) panneauxGroup.addLayer(layer); else streetsGroup.addLayer(layer); }
            });
            const percent = totalStreetsCount > 0 ? Math.round((doneCount / totalStreetsCount) * 100) : 0;
            document.getElementById('stats-text').innerText = `${doneCount} / ${totalStreetsCount} segments faits`;
            document.getElementById('stats-percent').innerText = `${percent}%`;
            document.getElementById('progress-bar').style.width = `${percent}%`;
        }

        function updateNotesDisplay() {
            notesGroup.clearLayers();
            Object.keys(latestNotesData).forEach(key => {
                const note = latestNotesData[key];
                const marker = L.circleMarker([note.lat, note.lng], {
                    radius: 8, fillColor: "#6f42c1", color: "white", weight: 2, opacity: 1, fillOpacity: 1
                });
                marker.bindTooltip(note.text, { direction: 'top', className: 'note-tooltip' });
                marker.bindPopup(`
                    <div style="text-align:center;">
                        <strong>Note</strong><br>${note.text}
                        <button onclick="deleteNote('${key}')" class="btn-delete-note">Supprimer</button>
                    </div>
                `, { className: 'note-popup' });
                notesGroup.addLayer(marker);
            });
        }

        function listenToDatabaseUpdates() {
            onValue(ref(db, 'rues'), (snapshot) => { latestFirebaseData = snapshot.val() || {}; updateMapDisplay(); });
            onValue(ref(db, 'notes'), (snapshot) => { latestNotesData = snapshot.val() || {}; updateNotesDisplay(); });
        }

        initMap();
    </script>
</body>
</html>
